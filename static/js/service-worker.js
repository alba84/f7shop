// Set this to true for production
var doCache = true;

// Name our cache
var CACHE_NAME = 'broccoli-pwa-cache-v1';

// Delete old caches that are not our current one!
self.addEventListener("activate", event => {
  const cacheWhitelist = [CACHE_NAME];
  event.waitUntil(
    caches.keys()
      .then(keyList =>
        Promise.all(keyList.map(key => {
          if (!cacheWhitelist.includes(key)) {
            console.log('Deleting cache: ' + key)
            return caches.delete(key);
          }
        }))
      )
  );
});

// The first time the user starts up the PWA, 'install' is triggered.
/*self.addEventListener('install', function(event) {
  if (doCache) {
    event.waitUntil(
      caches.open(CACHE_NAME)
        .then(function(cache) {
          // Get the assets manifest so we can see what our js file is named
          // This is because webpack hashes it
          fetch("/static/js/asset-manifest.json")
            .then(response => {
              response.json()
            })
            .then(assets => {
                console.log('assets', assets)
              // Open a cache and cache our files
              // We want to cache the page and the main.js generated by webpack
              // We could also cache any static assets like CSS or images
              const urlsToCache = [
                //"/",
                assets["/static/img/bg-login-40.jpg"],
                assets["main.js"]
              ]
              cache.addAll(urlsToCache)
              console.log('cached');
            })
        })
    );
  }
});*/
self.addEventListener('install', function(event) {
    if (doCache) {
        event.waitUntil(precache());
    }
});


// When the webpage goes to fetch files, we intercept that request and serve up the matching files
// if we have them
self.addEventListener('fetch', function(event) {
    /*console.log('this', this);
    event.respondWith(fromNetwork(event.request).catch(function () {
        return fromCache(event.request);
    }));*/
    event.respondWith(
        caches.match(event.request).then(function(resp) {
            return resp || fetch(event.request).then(function(response) {
                caches.open(CACHE_NAME).then(function(cache) {
                    cache.put(event.request, response.clone());
                });
                return response;
            });
        }).catch(function(r) {
            return caches.match('/static/img/no-photo.jpg');
        })
    );
});




function precache() {
    return caches.open(CACHE_NAME).then(function (cache) {
        return cache.addAll([
            './index.html',
            '/static/img/bg-login-40.jpg',
            '/static/img/no-photo.jpg',
            //'/static/js/app.js',
            '/static/fonts/Framework7Icons-Regular.9900d2b.ttf',
            '/static/fonts/Framework7Icons-Regular.bb6aae4.eot',
            '/static/fonts/Framework7Icons-Regular.eb7a418.woff',
            '/static/fonts/Framework7Icons-Regular.f3e1eae.woff2',
            '/static/fonts/MaterialIcons-Regular.012cf6a.woff',
            '/static/fonts/MaterialIcons-Regular.570eb83.woff2',
            '/static/fonts/MaterialIcons-Regular.a37b0c0.ttf',
            '/static/fonts/MaterialIcons-Regular.e79bfd8.eot',
        ]);
    });
}


function fromNetwork(request, timeout) {
    return new Promise(function (resolve, reject) {
        var timeoutId = setTimeout(reject, timeout);

        fetch(request).then(function (response) {
            clearTimeout(timeoutId);
            resolve(response);
        }, reject);
    });
}

function fromCache(request) {
    return new Promise((resolve, reject) => {
        resolve([{"id":921,"iblock_id":13,"name":"Чеснок молодой","infoves":"На развес","quantity":23.522,"weight":1000,"pre_picture":"\/upload\/resize_cache\/iblock\/c1e\/10_10_0\/c1e00c2ec26c5d7b7c6a4d3c45c3ad6f.jpg","picture":"\/upload\/resize_cache\/iblock\/c1e\/300_300_0\/c1e00c2ec26c5d7b7c6a4d3c45c3ad6f.jpg","currency":"RUB","price":550,"discount":192.5,"discount_price":357.5,"discount_percent":35,"measure_id":4,"measure_symbol":"кг","measure_ratio":0.3,"traced":true,"traced_receipt_in":false,"can_by_zero":false,"available":true},{"id":6086,"iblock_id":13,"name":"Блок для унитаза сменный 3в1 \"Атлантик\" Domestos, 40г","infoves":"Вес 1шт. - 40г.","quantity":9,"weight":58,"pre_picture":"\/upload\/resize_cache\/iblock\/d2b\/10_10_0\/d2b4191ebdd7826455146aaac9db80d9.jpg","picture":"\/upload\/resize_cache\/iblock\/d2b\/300_300_0\/d2b4191ebdd7826455146aaac9db80d9.jpg","currency":"RUB","price":42,"discount":10.5,"discount_price":31.5,"discount_percent":25,"measure_id":8,"measure_symbol":"шт","measure_ratio":1,"traced":true,"traced_receipt_in":false,"can_by_zero":false,"available":true},{"id":3592,"iblock_id":13,"name":"Сменный баллон \"Нежность шёлка и лилии\" для автоматического освежителя, Airwick, 250мл","infoves":"Объем 250мл","quantity":4,"weight":174,"pre_picture":"\/upload\/resize_cache\/iblock\/4b1\/10_10_0\/4b1733ffd95cc872e76db4548c398603.jpg","picture":"\/upload\/resize_cache\/iblock\/4b1\/300_300_0\/4b1733ffd95cc872e76db4548c398603.jpg","currency":"RUB","price":362,"discount":90.5,"discount_price":271.5,"discount_percent":25,"measure_id":5,"measure_symbol":"шт","measure_ratio":1,"traced":true,"traced_receipt_in":false,"can_by_zero":false,"available":true},{"id":3594,"iblock_id":13,"name":"Сменный баллон \"Свежесть водопада\" для автоматического освежителя, Airwick, 250мл","infoves":"Объем 250мл","quantity":7,"weight":174,"pre_picture":"\/upload\/resize_cache\/iblock\/dff\/10_10_0\/dff907e5909ba9a07bebd5920fd798f9.jpg","picture":"\/upload\/resize_cache\/iblock\/dff\/300_300_0\/dff907e5909ba9a07bebd5920fd798f9.jpg","currency":"RUB","price":330,"discount":82.5,"discount_price":247.5,"discount_percent":25,"measure_id":5,"measure_symbol":"шт","measure_ratio":1,"traced":true,"traced_receipt_in":false,"can_by_zero":false,"available":true},{"id":4815,"iblock_id":13,"name":"Гель для чистки унитазов \"Лемонграсс\", Meine Liebe, 750мл","infoves":"Объем 750мл","quantity":11,"weight":750,"pre_picture":"\/upload\/resize_cache\/iblock\/346\/10_10_0\/346cb8e124b2a58446b996024550175e.jpg","picture":"\/upload\/resize_cache\/iblock\/346\/300_300_0\/346cb8e124b2a58446b996024550175e.jpg","currency":"RUB","price":165,"discount":16.5,"discount_price":148.5,"discount_percent":10,"measure_id":5,"measure_symbol":"шт","measure_ratio":1,"traced":true,"traced_receipt_in":false,"can_by_zero":false,"available":true},{"id":6444,"iblock_id":13,"name":"Блок туалетный \"Тропические цветы\" Cillit Bang Power Wave","infoves":"","quantity":9,"weight":39,"pre_picture":"\/upload\/resize_cache\/iblock\/f1f\/10_10_0\/f1fe4304d3c3a68f0757131c754aef70.jpg","picture":"\/upload\/resize_cache\/iblock\/f1f\/300_300_0\/f1fe4304d3c3a68f0757131c754aef70.jpg","currency":"RUB","price":160,"discount":40,"discount_price":120,"discount_percent":25,"measure_id":5,"measure_symbol":"шт","measure_ratio":1,"traced":true,"traced_receipt_in":false,"can_by_zero":false,"available":true},{"id":3689,"iblock_id":13,"name":"Средство для мытья стекол, пластика и зеркал, Meine Liebe, 500мл","infoves":"Объем 500мл","quantity":2,"weight":500,"pre_picture":"\/upload\/resize_cache\/iblock\/f98\/10_10_0\/f982ea27302ea70afa0f6813414aa950.jpg","picture":"\/upload\/resize_cache\/iblock\/f98\/300_300_0\/f982ea27302ea70afa0f6813414aa950.jpg","currency":"RUB","price":158,"discount":15.8,"discount_price":142.2,"discount_percent":10,"measure_id":5,"measure_symbol":"шт","measure_ratio":1,"traced":true,"traced_receipt_in":false,"can_by_zero":false,"available":true},{"id":9355,"iblock_id":13,"name":"Сосиски \"Молочные\" ц\/о Рублевский, 480г","infoves":"Вес 1шт. - 480г","quantity":1,"weight":480,"pre_picture":"\/upload\/resize_cache\/iblock\/a08\/10_10_0\/a08775dc1cfd2e0db58ec8159b468a3b.jpg","picture":"\/upload\/resize_cache\/iblock\/a08\/300_300_0\/a08775dc1cfd2e0db58ec8159b468a3b.jpg","currency":"RUB","price":268,"discount":53.6,"discount_price":214.4,"discount_percent":20,"measure_id":5,"measure_symbol":"шт","measure_ratio":1,"traced":true,"traced_receipt_in":false,"can_by_zero":false,"available":true},{"id":9359,"iblock_id":13,"name":"Ветчина из свинины Для завтрака в\/с Рублевский, 400г","infoves":"Вес 1шт. - 400г","quantity":3,"weight":400,"pre_picture":"\/upload\/resize_cache\/iblock\/aa4\/10_10_0\/aa4708cff6b71f109456518624949dd2.jpg","picture":"\/upload\/resize_cache\/iblock\/aa4\/300_300_0\/aa4708cff6b71f109456518624949dd2.jpg","currency":"RUB","price":288,"discount":57.6,"discount_price":230.4,"discount_percent":20,"measure_id":5,"measure_symbol":"шт","measure_ratio":1,"traced":true,"traced_receipt_in":false,"can_by_zero":false,"available":true},{"id":2934,"iblock_id":13,"name":"Хлеб \"Американский Сэндвич\" пшеничный Harry's, 470г","infoves":"Вес 1 уп. - 470 г","quantity":2,"weight":475,"pre_picture":"\/upload\/resize_cache\/iblock\/0e4\/10_10_0\/0e426ab5f75b87ae248d38d5750b6c5d.jpg","picture":"\/upload\/resize_cache\/iblock\/0e4\/300_300_0\/0e426ab5f75b87ae248d38d5750b6c5d.jpg","currency":"RUB","price":75,"discount":11.25,"discount_price":63.75,"discount_percent":15,"measure_id":5,"measure_symbol":"шт","measure_ratio":1,"traced":true,"traced_receipt_in":false,"can_by_zero":false,"available":true}]);
    });
    /*return caches.open(CACHE_NAME).then(function (cache) {
        return cache.match(request).then(function (matching) {
            return matching || Promise.reject('no-match');
        });
    });*/
}